<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Math Analytics & Chapter Summary</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9ku4gWV0D08ugIETMevoLBNeft4hNWUk",
            authDomain: "ap-math-8783b.firebaseapp.com",
            projectId: "ap-math-8783b",
            storageBucket: "ap-math-8783b.firebasestorage.app",
            messagingSenderId: "357604958030",
            appId: "1:357604958030:web:b4bcd12bc9cccfefd6081f",
            measurementId: "G-JEREWFTDN3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Export to window for global access
        window.db = db;
        window.getDocs = getDocs;
        window.collection = collection;

        if (typeof window.startApp === "function") {
            window.startApp();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #1890ff; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { margin: 0; font-size: 14px; color: #888; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 28px; font-weight: bold; color: var(--primary); }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 350px; }
        .chart-container h4 { margin-top: 0; text-align: center; }

        .table-card { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fafafa; padding: 15px; text-align: left; border-bottom: 2px solid #f0f0f0; color: #555; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-blue { background: #e6f7ff; color: #1890ff; }
        .badge-green { background: #f6ffed; color: #52c41a; }

        @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>AP Math Analytics Dashboard</h1>
        <button onclick="location.reload()" style="padding: 8px 16px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: white;">Refresh Data</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Questions</h3>
            <p id="total-q">0</p>
        </div>
        <div class="stat-card">
            <h3>Total Marks</h3>
            <p id="total-m">0</p>
        </div>
        <div class="stat-card">
            <h3>Avg Difficulty</h3>
            <p id="avg-diff">0.0</p>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-container">
            <h4>Question Distribution</h4>
            <canvas id="countChart"></canvas>
        </div>
        <div class="chart-container">
            <h4>Mark Distribution</h4>
            <canvas id="marksChart"></canvas>
        </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Chapter Name</th>
                    <th>Questions</th>
                    <th>Mark Weightage</th>
                </tr>
            </thead>
            <tbody id="chapter-body">
                <tr><td colspan="3" style="text-align:center;">Loading database analytics...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let countChartInstance = null;
    let marksChartInstance = null;
    const chartColors = ['#1890ff', '#52c41a', '#722ed1', '#faad14', '#ff4d4f', '#13c2c2', '#eb2f96', '#fa8c16'];

    window.startApp = async () => {
        try {
            const catSnap = await window.getDocs(window.collection(window.db, "Category"));
            const qSnap = await window.getDocs(window.collection(window.db, "MathQuestion"));

            const categories = [];
            catSnap.forEach(doc => {
                const data = doc.data();
                if (!data.parent) { // Only track root chapters/categories
                    categories.push({ id: doc.id, name: data.name, count: 0, marks: 0 });
                }
            });

            let totalQ = 0;
            let totalM = 0;
            let totalDiff = 0;
            let diffCount = 0;

            qSnap.forEach(doc => {
                const q = doc.data();
                totalQ++;
                const marks = parseInt(q.marks) || 0;
                totalM += marks;

                if (q.difficulty) {
                    totalDiff += parseInt(q.difficulty);
                    diffCount++;
                }

                // Associate question with its primary category
                const qCats = q.categories || [];
                categories.forEach(cat => {
                    if (qCats.includes(cat.id)) {
                        cat.count++;
                        cat.marks += marks;
                    }
                });
            });

            renderTable(categories, totalQ, totalM);
            updateCharts(categories);
            
            document.getElementById('total-q').innerText = totalQ;
            document.getElementById('total-m').innerText = totalM;
            document.getElementById('avg-diff').innerText = diffCount > 0 ? (totalDiff/diffCount).toFixed(1) : "N/A";

        } catch (err) {
            console.error(err);
            document.getElementById('chapter-body').innerHTML = `<tr><td colspan="3" style="color:red">Error loading data: ${err.message}</td></tr>`;
        }
    };

    function renderTable(data, totalQ, totalM) {
        const tbody = document.getElementById('chapter-body');
        tbody.innerHTML = "";
        
        data.sort((a, b) => b.marks - a.marks).forEach(ch => {
            const qPerc = totalQ > 0 ? Math.round((ch.count / totalQ) * 100) : 0;
            const mWidth = totalM > 0 ? Math.round((ch.marks / totalM) * 100) : 0;

            const row = `
                <tr>
                    <td><strong>${ch.name}</strong></td>
                    <td>
                        <span class="badge badge-blue">${ch.count} Questions</span>
                        <small style="color:#999; margin-left:5px;">(${qPerc}%)</small>
                    </td>
                    <td style="background: linear-gradient(to right, #f6ffed ${mWidth}%, transparent ${mWidth}%);">
                        <span class="badge badge-green">${ch.marks} pts</span>
                    </td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    function updateCharts(data) {
        const activeData = data.filter(d => d.count > 0);
        const labels = activeData.map(d => d.name);
        const countValues = activeData.map(d => d.count);
        const markValues = activeData.map(d => d.marks);

        if (countChartInstance) countChartInstance.destroy();
        if (marksChartInstance) marksChartInstance.destroy();

        const ctx1 = document.getElementById('countChart').getContext('2d');
        countChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ data: countValues, backgroundColor: chartColors }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctx2 = document.getElementById('marksChart').getContext('2d');
        marksChartInstance = new Chart(ctx2, {
            type: 'pie',
            data: { 
                labels: labels, 
                datasets: [{ data: markValues, backgroundColor: chartColors }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>