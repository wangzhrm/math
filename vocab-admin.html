<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab Admin Panel</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #2a9d8f;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border: #dee2e6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --danger: #e63946;
      --warning: #ff9e00;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      color: var(--dark);
      line-height: 1.6;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 2.2rem;
      color: var(--primary);
      margin-bottom: 8px;
    }
    
    h2 {
      font-size: 1.8rem;
      color: var(--secondary);
      margin: 20px 0 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    label {
      font-weight: 600;
      color: var(--gray);
    }
    
    input[type="text"], 
    input[type="file"] {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      width: 100%;
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    
    /* Status Message */
    #uploadStatus {
      margin-top: 15px;
      padding: 12px;
      border-radius: var(--radius);
      display: none;
      font-weight: 600;
      background: #f0f7ff;
      border: 1px solid #cfe2ff;
    }

    /* Lists styling */
    .lists-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 15px;
      background: var(--light);
      border-radius: var(--radius);
      border: 2px dashed var(--border);
    }
    
    .list-item-wrapper {
      display: flex;
      align-items: center;
      gap: 5px;
      background: white;
      padding: 5px 10px;
      border-radius: 25px;
      border: 1px solid var(--border);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
    }

    .list-button {
      background: var(--primary);
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      cursor: grab;
      font-size: 0.9rem;
      font-weight: 600;
      user-select: none;
    }
    
    .delete-list-btn {
      color: var(--danger);
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      font-size: 0.9rem;
    }

    /* Users styling */
    .users-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .user-card {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    .user-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
      padding-bottom: 5px;
    }
    
    .user-lists {
      min-height: 80px;
      padding: 10px;
      background: white;
      border-radius: var(--radius);
      border: 2px dashed var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .assigned-list {
      background: #4cc9f0;
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .remove-list-btn {
      background: rgba(0,0,0,0.1);
      border: none;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .drag-over-user {
      background-color: rgba(67, 97, 238, 0.1) !important;
      border-color: var(--primary) !important;
    }
    
    .loading { text-align: center; padding: 20px; color: var(--gray); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-book-open"></i> Vocab Admin Panel</h1>
      <p>Manage vocabulary lists and user assignments</p>
    </header>

    <div class="card">
      <div class="section-title">
        <i class="fas fa-cloud-upload-alt"></i>
        <h2>Upload New Vocabulary List</h2>
      </div>
      <div class="input-group">
        <label for="excelFile">Excel File (.xlsx or .xls)</label>
        <input type="file" id="excelFile" accept=".xlsx,.xls" />
      </div>
      <div class="input-group">
        <label for="listName">List Name</label>
        <input type="text" id="listName" placeholder="e.g., Unit 1 Basic Nouns" />
      </div>
      <button class="btn btn-success" id="uploadBtn" onclick="uploadVocabList()">
        <i class="fas fa-upload"></i> Start Upload
      </button>
      
      <div id="uploadStatus"></div>
    </div>

    <div class="card">
      <div class="section-title">
        <i class="fas fa-th-large"></i>
        <h2>Available Vocabulary Lists</h2>
      </div>
      <div id="available-lists" class="lists-container">
        <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <i class="fas fa-users"></i>
        <h2>Users</h2>
      </div>
      <div id="users-list" class="users-list">
        <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const APP_ID = 'vALTi5ieVZvhJ44uiPMu5AFm-gzGzoHsz';
    const MASTER_KEY = '5rPpx9k9be8nSQZ2p7AwOzgc'; 
    const SERVER_URL = 'https://valti5ie.lc-cn-n1-shared.com';

    let allLists = [];
    let allUsers = [];

    async function adminRequest(method, path, data = null) {
      const url = `${SERVER_URL}/1.1${path}`;
      const headers = {
        'X-LC-Id': APP_ID,
        'X-LC-Key': MASTER_KEY + ',master',
        'Content-Type': 'application/json'
      };
      const config = { method, headers };
      if (data) config.body = JSON.stringify(data);
      const res = await fetch(url, config);
      return res.json();
    }

    window.onload = refreshData;

    async function refreshData() {
      try {
        const [students, lists] = await Promise.all([
          adminRequest('GET', '/classes/Student'),
          adminRequest('GET', '/classes/VocabList')
        ]);
        
        allUsers = students.results || [];
        allLists = lists.results || [];
        
        renderAvailableLists();
        renderUsers();
      } catch (error) {
        console.error('Refresh error:', error);
      }
    }

    function renderAvailableLists() {
      const container = document.getElementById('available-lists');
      if (allLists.length === 0) {
        container.innerHTML = '<p>No lists available.</p>';
        return;
      }
      
      container.innerHTML = '';
      allLists.forEach(list => {
        const wrapper = document.createElement('div');
        wrapper.className = 'list-item-wrapper';
        
        const listBtn = document.createElement('div');
        listBtn.className = 'list-button';
        listBtn.textContent = list.listName;
        listBtn.draggable = true;
        listBtn.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', list.objectId);
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-list-btn';
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.onclick = () => deleteEntireList(list.objectId);
        
        wrapper.appendChild(listBtn);
        wrapper.appendChild(delBtn);
        container.appendChild(wrapper);
      });
    }

    function renderUsers() {
      const container = document.getElementById('users-list');
      container.innerHTML = '';
      
      allUsers.forEach(user => {
        const assigned = allLists.filter(l => l.sharedWith && l.sharedWith.includes(user.username));
        
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
          <div class="user-name">${user.username}</div>
          <div class="user-lists" 
               ondragover="event.preventDefault()" 
               ondrop="handleDrop(event, '${user.username}')"
               ondragenter="this.classList.add('drag-over-user')"
               ondragleave="this.classList.remove('drag-over-user')">
            ${assigned.map(l => `
              <div class="assigned-list">
                ${l.listName}
                <button class="remove-list-btn" onclick="removeListFromUser('${l.objectId}', '${user.username}')">Ã—</button>
              </div>
            `).join('') || '<small style="color:#ccc">Drop lists here</small>'}
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function uploadVocabList() {
      const fileInput = document.getElementById('excelFile');
      const nameInput = document.getElementById('listName');
      const statusDiv = document.getElementById('uploadStatus');
      const uploadBtn = document.getElementById('uploadBtn');

      const file = fileInput.files[0];
      const listName = nameInput.value.trim();

      if (!file || !listName) {
        alert('Please select a file and enter a list name');
        return;
      }

      // Check for duplicates
      const exists = allLists.some(l => l.listName.toLowerCase() === listName.toLowerCase());
      if (exists) {
        alert(`Error: A list named "${listName}" already exists. Please choose a different name.`);
        return;
      }

      // Start UI Feedback
      uploadBtn.disabled = true;
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reading Excel file...';

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: ['english', 'chinese'] });
          const validRows = json.filter(r => r.english && r.chinese);

          if (validRows.length === 0) throw new Error("No valid data found in Excel.");

          // Step 1: Create List Metadata
          statusDiv.innerHTML = '<i class="fas fa-database"></i> Creating list entry...';
          await adminRequest('POST', '/classes/VocabList', { listName, sharedWith: [] });

          // Step 2: Upload words one by one
          for (let i = 0; i < validRows.length; i++) {
            const row = validRows[i];
            statusDiv.innerHTML = `<i class="fas fa-upload"></i> Uploading: ${i + 1} / ${validRows.length} words...`;
            await adminRequest('POST', '/classes/Vocabulary', {
              english: String(row.english).trim(),
              chinese: String(row.chinese).trim(),
              listName: listName
            });
          }

          statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Success! Refreshing...';
          fileInput.value = '';
          nameInput.value = '';
          await refreshData();
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);

        } catch (error) {
          alert('Upload failed: ' + error.message);
          statusDiv.style.display = 'none';
        } finally {
          uploadBtn.disabled = false;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function handleDrop(e, username) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over-user');
      const listId = e.dataTransfer.getData('text/plain');
      const list = allLists.find(l => l.objectId === listId);
      
      if (!list || (list.sharedWith && list.sharedWith.includes(username))) return;

      const updatedShared = [...(list.sharedWith || []), username];
      await adminRequest('PUT', `/classes/VocabList/${listId}`, { sharedWith: updatedShared });
      
      // Ensure StudentProgress entry exists
      const prog = await adminRequest('GET', `/classes/StudentProgress?where=${encodeURIComponent(JSON.stringify({studentUsername: username}))}`);
      if (prog.results.length === 0) {
        await adminRequest('POST', '/classes/StudentProgress', { studentUsername: username, removedWords: [], errorWords: [] });
      }

      await refreshData();
    }

    async function removeListFromUser(listId, username) {
      const list = allLists.find(l => l.objectId === listId);
      const updatedShared = list.sharedWith.filter(u => u !== username);
      await adminRequest('PUT', `/classes/VocabList/${listId}`, { sharedWith: updatedShared });
      await refreshData();
    }

    async function deleteEntireList(listId) {
      if (!confirm('Delete this entire list? This removes it from ALL users.')) return;
      const list = allLists.find(l => l.objectId === listId);
      
      // Delete vocab items
      const vocabs = await adminRequest('GET', `/classes/Vocabulary?where=${encodeURIComponent(JSON.stringify({listName: list.listName}))}`);
      for (const v of vocabs.results) {
        await adminRequest('DELETE', `/classes/Vocabulary/${v.objectId}`);
      }
      
      await adminRequest('DELETE', `/classes/VocabList/${listId}`);
      await refreshData();
    }
  </script>
</body>
</html>