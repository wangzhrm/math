<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab Admin - Secure Access</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --primary: #4361ee; --secondary: #7209b7; --success: #2a9d8f; --danger: #e63946; --warning: #ff9f1c;
      --group-color: #9d4edd; --border: #dee2e6; --radius: 12px; --bg: #f0f2f5;
    }
    
    #password-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: var(--primary); display: flex; align-items: center; 
      justify-content: center; z-index: 9999; flex-direction: column;
    }
    .login-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px; }
    .login-box h2 { margin-top: 0; color: var(--primary); }
    .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; text-align: center; font-size: 1.1rem; }
    .login-box button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }

    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
    #main-app { display: none; } 
    
    .admin-container { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 20px; align-items: start; height: calc(100vh - 40px); }
    .column { background: #e9ecef; border-radius: var(--radius); padding: 15px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; }
    .column h1 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 10px; color: #444; }

    .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
    .drop-zone { min-height: 50px; background: #fafafa; border: 2px dashed var(--border); border-radius: 8px; padding: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
    .drag-over { border-color: var(--primary); background: rgba(67, 97, 238, 0.05); }

    .tag { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 6px; color: white; user-select: none; }
    .tag-list { background: var(--primary); cursor: grab; position: relative; }
    .tag-user { background: var(--secondary); cursor: grab; }
    .tag-assigned { background: var(--primary); }
    .tag-group-assigned { background: var(--group-color); }
    .tag-member { background: #6c757d; }

    .remove-btn { background: rgba(0,0,0,0.2); border: none; color: white; border-radius: 50%; width: 14px; height: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; }
    .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
    input, button { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.85rem; }
    button { cursor: pointer; font-weight: 600; border: none; }
    
    .status-msg { font-size: 0.75rem; margin-top: 8px; color: var(--secondary); font-weight: bold; }
    .column::-webkit-scrollbar { width: 6px; }
    .column::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  </style>
</head>
<body>

<div id="password-overlay">
  <div class="login-box">
    <h2><i class="fas fa-lock"></i> Admin Login</h2>
    <input type="password" id="adminPass" placeholder="Enter Password" onkeypress="if(event.key==='Enter') verifyPass()">
    <button onclick="verifyPass()">Access Webpage</button>
    <p id="error-msg" style="color:red; font-size:0.8rem; margin-top:10px; display:none;">Incorrect Password</p>
  </div>
</div>

<div id="main-app">
  <div class="admin-container">
    
    <section class="column">
      <h1><i class="fas fa-book"></i> 1. Vocabulary</h1>
      <div class="card">
        <div class="input-group">
          <input type="text" id="listName" placeholder="New List Name">
          <input type="file" id="excelFile" accept=".xlsx, .xls">
          <button style="background:var(--success); color:white;" onclick="uploadVocabList()">Upload Excel</button>
        </div>
        <div id="vocab-status" class="status-msg" style="display:none;">
          <i class="fas fa-spinner fa-spin"></i> <span id="vocab-status-text">Ready</span>
        </div>
        <button style="background:var(--warning); color:white; width: 100%; font-size: 0.7rem; margin-top:10px;" onclick="initializeSortOrders()">
          <i class="fas fa-magic"></i> Fix Missing Sort Orders
        </button>
      </div>
      <div class="card">
        <span class="small-label">Vocabulary Pool (Drag to Reorder)</span>
        <div id="pool-lists" class="drop-zone" ondragover="evOver(event)" ondrop="handlePoolDrop(event)"></div>
      </div>
    </section>

    <section class="column">
      <h1><i class="fas fa-users-cog"></i> 2. Groups</h1>
      <div class="card">
        <div class="input-group">
          <input type="text" id="groupInput" placeholder="New Group Name">
          <button style="background:var(--primary); color:white;" onclick="createGroup()">Create Group</button>
        </div>
      </div>
      <div id="group-list-container"></div>
    </section>

    <section class="column">
      <h1><i class="fas fa-user-graduate"></i> 3. Student Review</h1>
      
      <div class="card">
        <span class="small-label">Bulk Upload Students (Col A: User, Col B: Pass)</span>
        <div class="input-group">
          <input type="file" id="studentExcelFile" accept=".xlsx, .xls">
          <button style="background:var(--secondary); color:white;" onclick="uploadStudentList()">
            <i class="fas fa-user-plus"></i> Upload Students
          </button>
        </div>
        <div id="student-status" class="status-msg" style="display:none;">
          <i class="fas fa-circle-notch fa-spin"></i> <span id="student-status-text">Ready</span>
        </div>
      </div>

      <div class="card">
        <span class="small-label">Student Pool (Drag to Groups)</span>
        <div id="pool-users" class="drop-zone"></div>
      </div>
      <div id="student-cards-container"></div>
    </section>

  </div>
</div>

<script>
const APP_ID = 'vALTi5ieVZvhJ44uiPMu5AFm-gzGzoHsz';
const MASTER_KEY = '5rPpx9k9be8nSQZ2p7AwOzgc'; 
const SERVER_URL = 'https://valti5ie.lc-cn-n1-shared.com';

let data = { users: [], lists: [], groups: [] };

function verifyPass() {
  const pass = document.getElementById('adminPass').value;
  if (pass === "wang123") {
    document.getElementById('password-overlay').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    load(); 
  } else {
    document.getElementById('error-msg').style.display = 'block';
    document.getElementById('adminPass').value = '';
  }
}

async function api(method, path, body = null) {
  const headers = { 'X-LC-Id': APP_ID, 'X-LC-Key': MASTER_KEY + ',master', 'Content-Type': 'application/json' };
  const res = await fetch(`${SERVER_URL}/1.1${path}`, { method, headers, body: body ? JSON.stringify(body) : null });
  return res.json();
}

async function load() {
  const [u, l, g] = await Promise.all([
    api('GET', '/classes/Student'),
    api('GET', '/classes/VocabList?order=sortOrder'),
    api('GET', '/classes/Group')
  ]);
  data = { users: u.results || [], lists: l.results || [], groups: g.results || [] };
  render();
}

// --- VOCABULARY LOGIC ---
async function uploadVocabList() {
  const file = document.getElementById('excelFile').files[0];
  const name = document.getElementById('listName').value.trim();
  const statusDiv = document.getElementById('vocab-status');
  const statusText = document.getElementById('vocab-status-text');

  if (!file || !name) return alert('List Name and Excel File required');

  const duplicate = data.lists.find(l => l.listName.toLowerCase() === name.toLowerCase());
  if (duplicate) return alert('A list with this name already exists.');

  statusDiv.style.display = 'block';
  statusText.innerText = "Processing...";

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: ['english', 'chinese'] });
      const validRows = json.filter(r => r.english && r.chinese);

      await api('POST', '/classes/VocabList', { listName: name, sharedWith: [], sortOrder: data.lists.length });

      let count = 0;
      for (const row of validRows) {
        statusText.innerText = `Uploading: ${count + 1}/${validRows.length}`;
        await api('POST', '/classes/Vocabulary', { 
          english: String(row.english).trim(), 
          chinese: String(row.chinese).trim(), 
          listName: name 
        });
        count++;
      }

      statusText.innerText = "Upload Complete!";
      document.getElementById('listName').value = "";
      setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);
      load();
    } catch (err) {
      alert("Error: " + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

async function delVocabList(id, name) {
  if (!confirm(`Are you sure you want to delete "${name}"? This will remove all words in this list.`)) return;
  
  const statusDiv = document.getElementById('vocab-status');
  const statusText = document.getElementById('vocab-status-text');
  statusDiv.style.display = 'block';
  statusText.innerText = "Deleting list entry...";

  try {
    // 1. Delete the list metadata
    await api('DELETE', `/classes/VocabList/${id}`);
    
    // 2. Fetch and delete words belonging to this list (Requires a query)
    statusText.innerText = "Cleaning up words...";
    const words = await api('GET', `/classes/Vocabulary?where={"listName":"${name}"}`);
    if (words.results) {
      for (const word of words.results) {
        await api('DELETE', `/classes/Vocabulary/${word.objectId}`);
      }
    }

    statusText.innerText = "Deleted Successfully";
    setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);
    load();
  } catch (err) {
    alert("Delete failed: " + err.message);
  }
}

// --- STUDENT UPLOAD ---
async function uploadStudentList() {
    const file = document.getElementById('studentExcelFile').files[0];
    const statusDiv = document.getElementById('student-status');
    const statusText = document.getElementById('student-status-text');

    if (!file) return alert('Select Excel file');

    statusDiv.style.display = 'block';
    statusText.innerText = "Uploading...";

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            const validRows = rows.filter(row => row[0] && row[1]);
            let count = 0;

            for (const row of validRows) {
                statusText.innerText = `Added: ${count + 1}/${validRows.length}`;
                await api('POST', '/classes/Student', { 
                    username: String(row[0]).trim(), 
                    password: String(row[1]).trim() 
                });
                count++;
            }
            statusText.innerText = "Complete";
            setTimeout(() => statusDiv.style.display = 'none', 2000);
            load();
        } catch (err) { alert("Error uploading"); }
    };
    reader.readAsArrayBuffer(file);
}

// --- DRAG, DROP & RENDER ---
function render() {
  // Pool Lists with Delete Button
  document.getElementById('pool-lists').innerHTML = data.lists.map(l => `
    <div class="tag tag-list" data-id="${l.objectId}" draggable="true" ondragstart="evDrag(event, 'list', '${l.objectId}')">
      <i class="fas fa-grip-vertical"></i> ${l.listName}
      <button class="remove-btn" onclick="delVocabList('${l.objectId}', '${l.listName}')">×</button>
    </div>`).join('');

  document.getElementById('pool-users').innerHTML = data.users.map(u => `
    <div class="tag tag-user" draggable="true" ondragstart="evDrag(event, 'user', '${u.username}')">${u.username}</div>`).join('');

  document.getElementById('group-list-container').innerHTML = data.groups.map(g => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <strong>${g.groupName} <i class="fas fa-edit edit-icon" onclick="renameGroup('${g.objectId}', '${g.groupName}')"></i></strong>
        <button onclick="delGroup('${g.objectId}')" style="color:var(--danger); background:none; padding:0">×</button>
      </div>
      <span class="small-label">Members</span>
      <div class="drop-zone" ondragover="evOver(event)" ondrop="evDrop(event, 'g-member', '${g.objectId}')">
        ${(g.members || []).map(m => `<div class="tag tag-member">${m}<button class="remove-btn" onclick="remMember('${g.objectId}','${m}')">×</button></div>`).join('')}
      </div>
      <span class="small-label">Group Lists</span>
      <div class="drop-zone" style="border-color:var(--group-color)" ondragover="evOver(event)" ondrop="evDrop(event, 'g-list', '${g.objectId}')">
        ${(g.sharedLists || []).map(lId => {
          const l = data.lists.find(x => x.objectId === lId);
          return l ? `<div class="tag tag-group-assigned">${l.listName}<button class="remove-btn" onclick="remListGroup('${g.objectId}','${lId}')">×</button></div>` : '';
        }).join('')}
      </div>
    </div>`).join('');

  document.getElementById('student-cards-container').innerHTML = data.users.map(u => {
    const individualLists = data.lists.filter(l => l.sharedWith?.includes(u.username));
    const groupListIds = [...new Set(data.groups.filter(g => g.members?.includes(u.username)).flatMap(g => g.sharedLists || []))];
    const groupLists = data.lists.filter(l => groupListIds.includes(l.objectId));

    return `
    <div class="card">
      <div style="display:flex; justify-content:space-between;">
        <strong><i class="fas fa-user"></i> ${u.username}</strong>
        <button onclick="delStudent('${u.objectId}')" style="color:var(--danger); background:none; font-size:0.8rem;">Delete</button>
      </div>
      <div class="drop-zone" style="margin-top:8px" ondragover="evOver(event)" ondrop="evDrop(event, 'u-list', '${u.username}')">
        ${individualLists.map(l => `<div class="tag tag-assigned">${l.listName}<button class="remove-btn" onclick="remListUser('${l.objectId}','${u.username}')">×</button></div>`).join('')}
        ${groupLists.map(l => `<div class="tag tag-group-assigned">${l.listName} <i class="fas fa-lock" style="font-size:0.6rem"></i></div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

async function handlePoolDrop(e) {
  e.preventDefault();
  const type = e.dataTransfer.getData("type");
  const draggedId = e.dataTransfer.getData("id");
  if (type !== 'list') return;
  const target = e.target.closest('.tag-list');
  if (!target || target.dataset.id === draggedId) return;

  const draggedIdx = data.lists.findIndex(l => l.objectId === draggedId);
  const targetIdx = data.lists.findIndex(l => l.objectId === target.dataset.id);
  const [movedItem] = data.lists.splice(draggedIdx, 1);
  data.lists.splice(targetIdx, 0, movedItem);

  render(); 
  for (let i = 0; i < data.lists.length; i++) {
    await api('PUT', `/classes/VocabList/${data.lists[i].objectId}`, { sortOrder: i });
  }
}

async function evDrop(e, targetType, targetId) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  const sType = e.dataTransfer.getData("type");
  const sId = e.dataTransfer.getData("id");

  if (targetType === 'g-member' && sType === 'user') {
    const g = data.groups.find(x => x.objectId === targetId);
    if (!g.members?.includes(sId)) await api('PUT', `/classes/Group/${targetId}`, { members: [...(g.members || []), sId] });
  } else if (targetType === 'g-list' && sType === 'list') {
    const g = data.groups.find(x => x.objectId === targetId);
    if (!g.sharedLists?.includes(sId)) await api('PUT', `/classes/Group/${targetId}`, { sharedLists: [...(g.sharedLists || []), sId] });
  } else if (targetType === 'u-list' && sType === 'list') {
    const l = data.lists.find(x => x.objectId === sId);
    if (!l.sharedWith?.includes(targetId)) await api('PUT', `/classes/VocabList/${sId}`, { sharedWith: [...(l.sharedWith || []), targetId] });
  }
  load();
}

// Helpers
function evDrag(e, type, id) { e.dataTransfer.setData("type", type); e.dataTransfer.setData("id", id); }
function evOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
async function delStudent(id) { if(confirm('Delete student?')) { await api('DELETE', `/classes/Student/${id}`); load(); } }
async function renameGroup(id, oldName) {
  const newName = prompt("New name:", oldName);
  if (newName && newName !== oldName) { await api('PUT', `/classes/Group/${id}`, { groupName: newName }); load(); }
}
async function remListGroup(gId, lId) {
  const g = data.groups.find(x => x.objectId === gId);
  await api('PUT', `/classes/Group/${gId}`, { sharedLists: (g.sharedLists || []).filter(id => id !== lId) });
  load();
}
async function remListUser(lId, user) {
  const l = data.lists.find(x => x.objectId === lId);
  await api('PUT', `/classes/VocabList/${lId}`, { sharedWith: (l.sharedWith || []).filter(u => u !== user) });
  load();
}
async function remMember(gId, user) {
  const g = data.groups.find(x => x.objectId === gId);
  await api('PUT', `/classes/Group/${gId}`, { members: g.members.filter(m => m !== user) });
  load();
}
async function createGroup() {
  const val = document.getElementById('groupInput').value;
  if (val) { await api('POST', '/classes/Group', { groupName: val, members: [], sharedLists: [] }); load(); }
}
async function delGroup(id) { if(confirm('Delete Group?')) { await api('DELETE', `/classes/Group/${id}`); load(); } }
async function initializeSortOrders() {
  if(!confirm("Fix orders?")) return;
  for (let i = 0; i < data.lists.length; i++) {
    await api('PUT', `/classes/VocabList/${data.lists[i].objectId}`, { sortOrder: i });
  }
  load();
}
</script>
</body>
</html>
