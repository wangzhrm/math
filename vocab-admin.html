<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab Admin - Sortable Pool</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --primary: #4361ee; --secondary: #7209b7; --success: #2a9d8f; --danger: #e63946; 
      --group-color: #9d4edd; --border: #dee2e6; --radius: 12px; 
    }
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
    .card { background: white; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
    h2 { font-size: 1.2rem; margin-bottom: 15px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    .drop-zone { min-height: 60px; background: #fdfdfd; border: 2px dashed var(--border); border-radius: 8px; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .drag-over { border-color: var(--primary); background: rgba(67, 97, 238, 0.05); }

    .tag { padding: 6px 12px; border-radius: 20px; font-size: 0.82rem; font-weight: 600; display: flex; align-items: center; gap: 6px; color: white; user-select: none; transition: transform 0.1s; }
    .tag-list { background: var(--primary); cursor: grab; border: 2px solid transparent; }
    .tag-list:active { cursor: grabbing; transform: scale(0.95); }
    /* Visual cue for reordering */
    .tag-list.reorder-target { border: 2px dashed white; opacity: 0.5; }

    .tag-user { background: var(--secondary); cursor: grab; }
    .tag-assigned { background: var(--primary); }
    .tag-group-assigned { background: var(--group-color); }
    .tag-member { background: #6c757d; }

    .remove-btn { background: rgba(0,0,0,0.2); border: none; color: white; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
    .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; }
    button { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
    
    .edit-icon { cursor: pointer; color: #aaa; margin-left: 8px; font-size: 0.9rem; }
    .legend { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.8rem; font-weight: bold; }
  </style>
</head>
<body>

<div class="card">
  <h2><i class="fas fa-tools"></i> Global Controls</h2>
  <div class="input-group">
    <input type="text" id="groupInput" placeholder="New Group Name">
    <button style="background:var(--primary); color:white;" onclick="createGroup()">Create Group</button>
  </div>
  <div class="input-group">
    <input type="file" id="excelFile">
    <input type="text" id="listName" placeholder="Excel List Name">
    <button style="background:var(--success); color:white;" onclick="uploadVocabList()">Upload Excel</button>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h2><i class="fas fa-sort-amount-down"></i> Vocabulary Pool (Drag to reorder)</h2>
    <div id="pool-lists" class="drop-zone" ondragover="evOver(event)" ondrop="handlePoolDrop(event)"></div>
  </div>
  <div class="card">
    <h2><i class="fas fa-users"></i> Student Pool</h2>
    <div id="pool-users" class="drop-zone"></div>
  </div>
</div>

<div class="legend">
  <span style="color: var(--primary)">● Individual List</span>
  <span style="color: var(--group-color)">● Group List (Inherited)</span>
</div>

<div class="grid" id="main-grid"></div>

<script>
const APP_ID = 'vALTi5ieVZvhJ44uiPMu5AFm-gzGzoHsz';
const MASTER_KEY = '5rPpx9k9be8nSQZ2p7AwOzgc'; 
const SERVER_URL = 'https://valti5ie.lc-cn-n1-shared.com';

let data = { users: [], lists: [], groups: [] };

async function api(method, path, body = null) {
  const headers = { 'X-LC-Id': APP_ID, 'X-LC-Key': MASTER_KEY + ',master', 'Content-Type': 'application/json' };
  const res = await fetch(`${SERVER_URL}/1.1${path}`, { method, headers, body: body ? JSON.stringify(body) : null });
  return res.json();
}

async function load() {
  const [u, l, g] = await Promise.all([
    api('GET', '/classes/Student'),
    api('GET', '/classes/VocabList?order=sortOrder'), // Load in correct order
    api('GET', '/classes/Group')
  ]);
  data = { users: u.results || [], lists: l.results || [], groups: g.results || [] };
  render();
}

// --- NEW: REORDER LOGIC ---
async function handlePoolDrop(e) {
  e.preventDefault();
  const type = e.dataTransfer.getData("type");
  const draggedId = e.dataTransfer.getData("id");
  
  if (type !== 'list') return;

  // Find the element we dropped near
  const target = e.target.closest('.tag-list');
  if (!target || target.dataset.id === draggedId) return;

  const targetId = target.dataset.id;
  const draggedIdx = data.lists.findIndex(l => l.objectId === draggedId);
  const targetIdx = data.lists.findIndex(l => l.objectId === targetId);

  // Reorder the local array
  const [movedItem] = data.lists.splice(draggedIdx, 1);
  data.lists.splice(targetIdx, 0, movedItem);

  // Update all sortOrders in the database
  render(); // Instant UI update
  for (let i = 0; i < data.lists.length; i++) {
    await api('PUT', `/classes/VocabList/${data.lists[i].objectId}`, { sortOrder: i });
  }
}

function render() {
  // Pool Rendering with data-id for sorting
  document.getElementById('pool-lists').innerHTML = data.lists.map(l => `
    <div class="tag tag-list" 
         data-id="${l.objectId}" 
         draggable="true" 
         ondragstart="evDrag(event, 'list', '${l.objectId}')">
      <i class="fas fa-grip-vertical" style="opacity:0.5; font-size:0.7rem"></i> ${l.listName}
    </div>`).join('');

  document.getElementById('pool-users').innerHTML = data.users.map(u => `
    <div class="tag tag-user" draggable="true" ondragstart="evDrag(event, 'user', '${u.username}')">
      ${u.username}
    </div>`).join('');

  let html = '';
  // Groups Rendering
  data.groups.forEach(g => {
    html += `
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span><strong>${g.groupName}</strong> <i class="fas fa-edit edit-icon" onclick="renameGroup('${g.objectId}', '${g.groupName}')"></i></span>
        <button onclick="delGroup('${g.objectId}')" style="color:red; background:none">×</button>
      </div>
      <div class="drop-zone" style="margin-top:10px" ondragover="evOver(event)" ondrop="evDrop(event, 'g-member', '${g.objectId}')">
        ${(g.members || []).map(m => `<div class="tag tag-member">${m}<button class="remove-btn" onclick="remMember('${g.objectId}','${m}')">×</button></div>`).join('') || '<small>Drop students</small>'}
      </div>
      <div class="drop-zone" style="margin-top:10px; border-color:var(--group-color)" ondragover="evOver(event)" ondrop="evDrop(event, 'g-list', '${g.objectId}')">
        ${(g.sharedLists || []).map(lId => {
          const l = data.lists.find(x => x.objectId === lId);
          return l ? `<div class="tag tag-group-assigned">${l.listName}<button class="remove-btn" onclick="remListGroup('${g.objectId}','${lId}')">×</button></div>` : '';
        }).join('') || '<small>Drop group lists</small>'}
      </div>
    </div>`;
  });

  // Students Rendering
  data.users.forEach(u => {
    const individualLists = data.lists.filter(l => l.sharedWith?.includes(u.username));
    const studentGroups = data.groups.filter(g => g.members?.includes(u.username));
    const groupListIds = [...new Set(studentGroups.flatMap(g => g.sharedLists || []))];
    const groupLists = data.lists.filter(l => groupListIds.includes(l.objectId));

    html += `
    <div class="card">
      <strong>Student: ${u.username}</strong>
      <div class="drop-zone" style="margin-top:10px" ondragover="evOver(event)" ondrop="evDrop(event, 'u-list', '${u.username}')">
        ${individualLists.map(l => `<div class="tag tag-assigned">${l.listName}<button class="remove-btn" onclick="remListUser('${l.objectId}','${u.username}')">×</button></div>`).join('')}
        ${groupLists.map(l => `<div class="tag tag-group-assigned">${l.listName} <i class="fas fa-lock" style="font-size:0.6rem"></i></div>`).join('')}
      </div>
    </div>`;
  });
  document.getElementById('main-grid').innerHTML = html;
}

// Rest of your functions (evDrag, evDrop, etc.) remain the same...
function evDrag(e, type, id) { e.dataTransfer.setData("type", type); e.dataTransfer.setData("id", id); }
function evOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }

async function evDrop(e, targetType, targetId) {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  const sType = e.dataTransfer.getData("type");
  const sId = e.dataTransfer.getData("id");

  if (targetType === 'g-member' && sType === 'user') {
    const g = data.groups.find(x => x.objectId === targetId);
    if (!g.members?.includes(sId)) await api('PUT', `/classes/Group/${targetId}`, { members: [...(g.members || []), sId] });
  } else if (targetType === 'g-list' && sType === 'list') {
    const g = data.groups.find(x => x.objectId === targetId);
    if (!g.sharedLists?.includes(sId)) await api('PUT', `/classes/Group/${targetId}`, { sharedLists: [...(g.sharedLists || []), sId] });
  } else if (targetType === 'u-list' && sType === 'list') {
    const l = data.lists.find(x => x.objectId === sId);
    if (!l.sharedWith?.includes(targetId)) await api('PUT', `/classes/VocabList/${sId}`, { sharedWith: [...(l.sharedWith || []), targetId] });
  }
  load();
}

async function renameGroup(id, oldName) {
  const newName = prompt("New group name:", oldName);
  if (newName && newName !== oldName) { await api('PUT', `/classes/Group/${id}`, { groupName: newName }); load(); }
}

async function remListGroup(gId, lId) {
  const g = data.groups.find(x => x.objectId === gId);
  await api('PUT', `/classes/Group/${gId}`, { sharedLists: (g.sharedLists || []).filter(id => id !== lId) });
  load();
}

async function remListUser(lId, user) {
  const l = data.lists.find(x => x.objectId === lId);
  await api('PUT', `/classes/VocabList/${lId}`, { sharedWith: (l.sharedWith || []).filter(u => u !== user) });
  load();
}

async function remMember(gId, user) {
  const g = data.groups.find(x => x.objectId === gId);
  await api('PUT', `/classes/Group/${gId}`, { members: g.members.filter(m => m !== user) });
  load();
}

async function createGroup() {
  const val = document.getElementById('groupInput').value;
  if (val) { await api('POST', '/classes/Group', { groupName: val, members: [], sharedLists: [] }); load(); }
}

async function delGroup(id) { if(confirm('Delete Group?')) { await api('DELETE', `/classes/Group/${id}`); load(); } }

async function uploadVocabList() {
  const file = document.getElementById('excelFile').files[0], name = document.getElementById('listName').value;
  if (!file || !name) return alert('Name and File required');
  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: ['english', 'chinese'] });
    // Default sortOrder to the end of the current list length
    await api('POST', '/classes/VocabList', { listName: name, sharedWith: [], sortOrder: data.lists.length });
    for (const row of json.filter(r => r.english && r.chinese)) {
      await api('POST', '/classes/Vocabulary', { english: String(row.english).trim(), chinese: String(row.chinese).trim(), listName: name });
    }
    alert('Uploaded'); load();
  };
  reader.readAsArrayBuffer(file);
}

window.onload = load;
</script>
</body>
</html>
