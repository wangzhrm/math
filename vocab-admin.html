<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AST Secure Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f; --sidebar-w: 320px; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 5000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        #app-wrapper { display: none; width: 100%; height: 100%; flex-direction: row; }

        #drawer {
            position: fixed; left: calc(-1 * var(--sidebar-w)); top: 0;
            width: var(--sidebar-w); height: 100%; background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000;
            transition: left 0.3s ease; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        #drawer.open { left: 0; }
        #toggle-bar {
            position: fixed; left: 0; top: 0; width: 30px; height: 100%;
            background: #444; color: white; cursor: pointer; z-index: 1001;
            display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl;
            font-size: 12px; letter-spacing: 2px; transition: left 0.3s ease;
        }
        #drawer.open + #toggle-bar { left: var(--sidebar-w); }

        .main-container { flex: 1; display: flex; margin-left: 30px; width: calc(100% - 30px); }
        .editor-area { flex: 1; padding: 20px; overflow-y: auto; }
        .right-sidebar { width: 420px; background: #fff; border-left: 1px solid #ddd; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        textarea, .url-input { width: 100%; margin: 10px 0; border: 1px solid #d9d9d9; padding: 10px; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        
        /* Layout for Question Preview with Diagram */
        .preview-container { display: flex; gap: 15px; align-items: flex-start; min-height: 50px; padding: 15px; border: 1px dashed #ccc; border-radius: 4px; margin-bottom: 20px; }
        .preview-text { flex: 1; line-height: 1.6; white-space: pre-wrap; }
        .preview-diagram { width: 200px; border-left: 1px solid #eee; padding-left: 15px; display: none; }
        .preview-diagram img { max-width: 100%; height: auto; border-radius: 4px; }

        #qP-box { background: #f6ffed; border-color: #b7eb8f; }
        #sP-box { background: #e6f7ff; border-color: #91d5ff; }
        
        .tag { background: #e6f7ff; color: #1890ff; padding: 2px 6px; border-radius: 4px; margin-right: 4px; font-size: 10px; border: 1px solid #91d5ff; }
        .q-list-item { padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 6px; font-size: 12px; }
        button { cursor: pointer; border-radius: 4px; border: none; font-weight: bold; padding: 8px 12px; }
        .primary-btn { background: var(--primary); color: white; width: 100%; }
        .save-btn { background: var(--success); color: white; width: 100%; margin-top: 10px; position: sticky; bottom: 0; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2>AST Secure Login</h2>
        <input type="text" id="userInput" placeholder="Username">
        <input type="password" id="passInput" placeholder="Password">
        <button onclick="attemptLogin()" class="primary-btn">Unlock System</button>
    </div>
</div>

<div id="app-wrapper">
    <div id="drawer">
        <h3>Categories</h3>
        <input type="text" id="newCatName" placeholder="New Category...">
        <select id="targetParent" style="width:100%; margin: 10px 0;"><option value="">New Root</option></select>
        <button onclick="addCategory()" class="primary-btn">Add</button>
        <div id="categoryTree" style="overflow-y: auto; flex: 1; margin-top:10px;"></div>
    </div>

    <div id="toggle-bar" onclick="toggleDrawer()">â˜° CATEGORIES</div>

    <div class="main-container">
        <div class="editor-area">
            <div class="card">
                <h2 id="editor-title" style="margin-top:0;">Question Editor</h2>
                <input type="hidden" id="editingId" value="">
                
                <strong>Question LaTeX</strong>
                <textarea id="qInput" oninput="updatePreviews()"></textarea>
                
                <strong>Diagram Image URL (Optional)</strong>
                <input type="text" id="diagUrl" class="url-input" placeholder="https://example.com/image.png" oninput="updatePreviews()">
                
                <div id="qP-box" class="preview-container">
                    <div id="qText" class="preview-text">Question Preview</div>
                    <div id="qDiag" class="preview-diagram"></div>
                </div>

                <strong>Solution LaTeX</strong>
                <textarea id="sInput" oninput="updatePreviews()"></textarea>
                <div id="sP-box" class="preview-container">
                    <div id="sText" class="preview-text">Solution Preview</div>
                </div>
            </div>
        </div>

        <div class="right-sidebar">
            <h3>Categorization</h3>
            <div id="editorHierarchies"></div>
            <button class="save-btn" onclick="submitQuestion()">SAVE QUESTION</button>
            <button id="cancelEdit" style="display:none; margin-top:5px; width:100%;" onclick="resetEditor(true)">Cancel Edit</button>

            <h3 style="margin-top:20px;">Manager</h3>
            <input type="text" id="qSearch" placeholder="Search..." oninput="fetchQuestions()" class="url-input">
            <div id="dynamicFilters"></div>
            <div id="existingQuestionsList"></div>
        </div>
    </div>
</div>

<script>
    AV.init({ appId: "XjQ3V5jxCqhiZfjZf0JFLNiN-gzGzoHsz", appKey: "LJwsKB85okDVlJODxvQTBdrX", serverURL: "https://xjq3v5jx.lc-cn-n1-shared.com" });
    const Category = AV.Object.extend('Category');
    const MathQuestion = AV.Object.extend('MathQuestion');
    let categoryMap = {};

    async function attemptLogin() {
        const u = document.getElementById('userInput').value;
        const p = document.getElementById('passInput').value;
        const query = new AV.Query('Master');
        query.equalTo('username', u); query.equalTo('password', p);
        const result = await query.first();
        if (result) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'flex';
            await renderApp(); fetchQuestions();
        } else { alert("Login failed"); }
    }

    function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }

    function updatePreviews() {
        const qVal = document.getElementById('qInput').value;
        const sVal = document.getElementById('sInput').value;
        const url = document.getElementById('diagUrl').value.trim();

        // Update Text
        document.getElementById('qText').innerHTML = qVal.replace(/\n/g, '<br>') || "Question Preview";
        document.getElementById('sText').innerHTML = sVal.replace(/\n/g, '<br>') || "Solution Preview";

        // Update Diagram
        const diagDiv = document.getElementById('qDiag');
        if (url) {
            diagDiv.innerHTML = `<img src="${url}" alt="Diagram">`;
            diagDiv.style.display = 'block';
        } else {
            diagDiv.style.display = 'none';
        }

        MathJax.typesetPromise([document.getElementById('qText'), document.getElementById('sText')]);
    }

    async function submitQuestion() {
        const qId = document.getElementById('editingId').value;
        const selects = document.querySelectorAll('.question-cat-select');
        let catIds = [];
        selects.forEach(s => catIds = catIds.concat(Array.from(s.selectedOptions).map(o => o.value)));
        
        if (catIds.length === 0) return alert("Select a category");

        const mq = qId ? AV.Object.createWithoutData('MathQuestion', qId) : new MathQuestion();
        mq.set('latexQuestion', document.getElementById('qInput').value);
        mq.set('latexSolution', document.getElementById('sInput').value);
        mq.set('diagramUrl', document.getElementById('diagUrl').value.trim());
        mq.set('categories', catIds.map(id => AV.Object.createWithoutData('Category', id)));
        
        await mq.save();
        alert("Saved!"); resetEditor(false); fetchQuestions();
    }

    async function editQuestion(id) {
        const q = await new AV.Query('MathQuestion').get(id);
        document.getElementById('editingId').value = id;
        document.getElementById('qInput').value = q.get('latexQuestion') || "";
        document.getElementById('sInput').value = q.get('latexSolution') || "";
        document.getElementById('diagUrl').value = q.get('diagramUrl') || "";
        document.getElementById('cancelEdit').style.display = "block";
        
        const selectedIds = (q.get('categories') || []).map(c => c.id);
        document.querySelectorAll('.question-cat-select').forEach(sel => {
            Array.from(sel.options).forEach(opt => opt.selected = selectedIds.includes(opt.value));
        });
        updatePreviews();
    }

    function resetEditor(force) {
        document.getElementById('editingId').value = "";
        document.getElementById('qInput').value = "";
        document.getElementById('sInput').value = "";
        document.getElementById('diagUrl').value = "";
        document.getElementById('cancelEdit').style.display = "none";
        if(force) {
            document.querySelectorAll('.question-cat-select').forEach(s => s.selectedIndex = -1);
        }
        updatePreviews();
    }

    async function fetchQuestions() {
        const search = document.getElementById('qSearch').value;
        const query = new AV.Query('MathQuestion');
        query.limit(30); query.descending('createdAt'); query.include('categories');
        if(search) query.contains('latexQuestion', search);
        
        const results = await query.find();
        const container = document.getElementById('existingQuestionsList');
        container.innerHTML = "";
        results.forEach(q => {
            const tags = (q.get('categories') || []).map(c => `<span class="tag">${categoryMap[c.id] || ''}</span>`).join('');
            const div = document.createElement('div');
            div.className = 'q-list-item';
            div.innerHTML = `<div>${tags}</div><div style="color:#666; margin:5px 0;">${(q.get('latexQuestion') || '').substring(0,40)}...</div>
                             <button onclick="editQuestion('${q.id}')">Edit</button>`;
            container.appendChild(div);
        });
    }

    async function renderApp() {
        const cats = await new AV.Query('Category').ascending('order').find();
        const tree = document.getElementById('categoryTree');
        const editor = document.getElementById('editorHierarchies');
        tree.innerHTML = ""; editor.innerHTML = "";
        cats.forEach(c => categoryMap[c.id] = c.get('name'));

        const roots = cats.filter(c => !c.get('parent'));
        roots.forEach(root => {
            const children = cats.filter(c => c.get('parent')?.id === root.id);
            const box = document.createElement('div');
            box.innerHTML = `<strong>${root.get('name')}</strong><br><select multiple class="question-cat-select" style="width:100%; height:80px;">
                ${children.map(ch => `<option value="${ch.id}">${ch.get('name')}</option>`).join('')}</select><br><br>`;
            editor.appendChild(box);
            document.getElementById('targetParent').innerHTML += `<option value="${root.id}">${root.get('name')}</option>`;
        });
    }

    async function addCategory() {
        const n = document.getElementById('newCatName').value;
        const p = document.getElementById('targetParent').value;
        const c = new Category(); c.set('name', n);
        if(p) c.set('parent', AV.Object.createWithoutData('Category', p));
        await c.save(); location.reload();
    }
</script>
</body>
</html>
