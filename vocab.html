<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vocab Learner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --danger: #e63946;
      --success: #2a9d8f;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: white;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f5f7ff, #eef2ff);
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      min-height: 100vh;
    }

    .container { max-width: 500px; margin: 0 auto; }
    .hidden { display: none !important; }

    h1, h2, h3 { font-weight: 600; margin-bottom: 16px; color: var(--primary-dark); }
    h2 { text-align: center; font-size: 1.8rem; }

    input, button {
      font-family: inherit;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid #ddd;
      font-size: 16px;
      width: 100%;
      margin-bottom: 12px;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      min-height: 48px;
    }

    button:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

    .screen { animation: fadeIn 0.3s ease; padding: 24px 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Flashcard UI */
    .flashcard-container {
      perspective: 1000px;
      margin: 30px 0;
      display: flex;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 340px;
      height: 220px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .card.flipped { transform: rotateY(180deg); }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
      border-radius: var(--radius);
      overflow: hidden;
      font-size: 1.8rem;
      font-weight: 600;
      word-break: break-word;
    }

    .card-face.long-text { font-size: 1.2rem; line-height: 1.3; }
    .card-front { background: var(--primary); color: white; }
    .card-back { background: var(--card-bg); color: var(--dark); transform: rotateY(180deg); }

    #card-action-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(230, 57, 70, 0.9);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.75rem;
      width: auto;
      min-height: unset;
      z-index: 10;
      font-weight: 700;
      text-transform: uppercase;
    }

    .nav-buttons { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
    .nav-buttons button { flex: 1; max-width: 140px; }

    .list-btn {
      background: white; color: var(--primary); border: 2px solid var(--primary);
      text-align: left; padding: 16px 20px; font-weight: 600; border-radius: var(--radius);
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    #quiz-options { display: flex; flex-direction: column; gap: 12px; margin: 24px 0; }
    #quiz-options button { background: white; color: var(--dark); border: 2px solid #e0e0e0; text-align: left; padding: 16px; }
    #quiz-options button.selected { border-color: var(--primary); background: #f0f3ff; }
    
    .progress-text { text-align: center; font-size: 0.9rem; color: var(--gray); margin-bottom: 8px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-screen" class="screen">
      <h2>üìò Vocab Learner</h2>
      <input type="text" id="username" placeholder="Username" autocomplete="username" />
      <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
      <button onclick="login()">Login</button>
    </div>

    <div id="main-menu" class="screen hidden">
      <h2>Welcome, <span id="user-display"></span>!</h2>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button onclick="showMode('learn')">üìñ Learning Mode</button>
        <button onclick="showMode('quiz')">üß† Quiz Mode</button>
        <button class="btn-outline" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="learn-mode" class="screen hidden">
      <h2>Select Vocabulary List</h2>
      <div id="vocab-lists-learn" class="list-container"></div>
      <button class="btn-outline" onclick="backToMenu()">‚Üê Back</button>
    </div>

    <div id="flashcard-view" class="screen hidden">
      <h3 id="current-list-title" style="text-align:center; margin-bottom:4px;"></h3>
      <div id="learn-progress" class="progress-text"></div>
      <div class="flashcard-container">
        <div class="card" id="flashcard" onclick="flipCard()">
          <div class="card-face card-front" id="card-front"></div>
          <div class="card-face card-back" id="card-back"></div>
          <button id="card-action-btn" onclick="event.stopPropagation(); handleCardAction()">Remove</button>
        </div>
      </div>
      <div class="nav-buttons">
        <button onclick="prevCard()">‚Üê Prev</button>
        <button onclick="nextCard()">Next ‚Üí</button>
      </div>
      <button class="btn-outline" style="margin-top:20px;" onclick="exitFlashcards()">Exit</button>
    </div>

    <div id="quiz-mode" class="screen hidden">
      <h2>Select Quiz List</h2>
      <div id="vocab-lists-quiz" class="list-container"></div>
      <button class="btn-outline" onclick="backToMenu()">‚Üê Back</button>
    </div>

    <div id="quiz-question" class="screen hidden">
      <h3 id="quiz-list-title" style="text-align:center; margin-bottom:4px;"></h3>
      <div id="quiz-progress" class="progress-text"></div>
      <p style="font-size:1.3rem; margin:20px 0; text-align:center;">What does "<strong id="quiz-word"></strong>" mean?</p>
      <div id="quiz-options"></div>
      <button onclick="submitQuizAnswer()">Submit Answer</button>
    </div>
  </div>

<script>
const APP_ID = 'vALTi5ieVZvhJ44uiPMu5AFm-gzGzoHsz';
const APP_KEY = 'IMjFEXa4Zbtspl6jRYc9eMTK';
const SERVER_URL = 'https://valti5ie.lc-cn-n1-shared.com';

let currentUser = null;
let currentVocabList = null;
let currentVocabs = [];
let currentIndex = 0;
let quizQuestions = [];
let quizIndex = 0;
let correctCount = 0;
let wrongAnswers = [];
let selectedOptionBtn = null;

async function leanRequest(method, path, data = null) {
  const url = `${SERVER_URL}/1.1${path}`;
  const headers = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'Content-Type': 'application/json' };
  const config = { method, headers };
  if (data) config.body = JSON.stringify(data);
  const res = await fetch(url, config);
  return res.json();
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const res = await leanRequest('GET', `/classes/Student?where=${encodeURIComponent(JSON.stringify({username, password}))}`);
  if (res.results && res.results.length > 0) {
    currentUser = username;
    document.getElementById('user-display').textContent = username;
    showScreen('main-menu');
    await loadVocabLists();
  } else { alert('Invalid credentials'); }
}

function logout() { currentUser = null; showScreen('login-screen'); }

function showMode(mode) {
  renderVocabLists(mode);
  showScreen(mode === 'learn' ? 'learn-mode' : 'quiz-mode');
}

function backToMenu() { showScreen('main-menu'); }

async function loadVocabLists() {
  const progressRes = await leanRequest('GET', `/classes/StudentProgress?where=${encodeURIComponent(JSON.stringify({studentUsername: currentUser}))}`);
  const groupRes = await leanRequest('GET', `/classes/Group?where=${encodeURIComponent(JSON.stringify({members: currentUser}))}`);
  const groupListIds = [...new Set(groupRes.results.flatMap(g => g.sharedLists || []))];
  const allListsRes = await leanRequest('GET', '/classes/VocabList');
  
  let accessibleNames = [];
  allListsRes.results.forEach(list => {
    if (list.sharedWith?.includes(currentUser) || groupListIds.includes(list.objectId)) {
      accessibleNames.push(list.listName);
    }
  });

  if (progressRes.results[0]?.removedWords?.length > 0) accessibleNames.push('Removed Words');
  window.vocabLists = [...new Set(accessibleNames)];
}

function renderVocabLists(mode) {
  const container = mode === 'learn' ? document.getElementById('vocab-lists-learn') : document.getElementById('vocab-lists-quiz');
  container.innerHTML = '';
  
  if (!window.vocabLists || window.vocabLists.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:gray; margin-top:20px;">No lists assigned.</p>';
  }

  window.vocabLists.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'list-btn';
    btn.textContent = name;
    btn.onclick = () => startMode(mode, name);
    container.appendChild(btn);
  });

  if (mode === 'quiz') {
    const errorBtn = document.createElement('button');
    errorBtn.className = 'list-btn';
    errorBtn.style.color = 'var(--danger)';
    errorBtn.textContent = 'üö® Error List';
    errorBtn.onclick = () => startMode('quiz-error', 'Error List');
    container.appendChild(errorBtn);
  }
}

async function startMode(mode, listName) {
  const progressRes = await leanRequest('GET', `/classes/StudentProgress?where=${encodeURIComponent(JSON.stringify({studentUsername: currentUser}))}`);
  const removedIds = progressRes.results[0]?.removedWords || [];

  if (mode === 'learn') {
    if (listName === 'Removed Words') {
      const idsQuery = removedIds.map(id => `"${id}"`).join(',');
      const vocabRes = await leanRequest('GET', `/classes/Vocabulary?where=${encodeURIComponent(`{"objectId":{"$in":[${idsQuery}]}}`)}`);
      currentVocabs = vocabRes.results;
    } else {
      const vocabRes = await leanRequest('GET', `/classes/Vocabulary?where=${encodeURIComponent(JSON.stringify({listName}))}`);
      currentVocabs = vocabRes.results.filter(v => !removedIds.includes(v.objectId));
    }
    
    if (currentVocabs.length === 0) return alert('List is empty!');
    currentVocabList = listName;
    showFlashcard(0);
  } else {
    let vocabs = [];
    if (listName === 'Error List') {
      const errorIds = progressRes.results[0]?.errorWords || [];
      if (errorIds.length === 0) return alert('No words in error list!');
      const idsQuery = errorIds.map(id => `"${id}"`).join(',');
      const vocabRes = await leanRequest('GET', `/classes/Vocabulary?where=${encodeURIComponent(`{"objectId":{"$in":[${idsQuery}]}}`)}`);
      vocabs = vocabRes.results;
    } else {
      const vocabRes = await leanRequest('GET', `/classes/Vocabulary?where=${encodeURIComponent(JSON.stringify({listName}))}`);
      vocabs = vocabRes.results;
    }
    quizQuestions = [...vocabs].sort(() => 0.5 - Math.random());
    quizIndex = 0; correctCount = 0; wrongAnswers = [];
    currentVocabList = listName;
    showQuizQuestion();
  }
}

function showFlashcard(index) {
  currentIndex = index;
  const word = currentVocabs[index];
  const btn = document.getElementById('card-action-btn');
  
  // Set button text based on the active list
  if (currentVocabList === 'Removed Words') {
    btn.textContent = 'Move Back';
    btn.style.background = 'var(--success)';
  } else {
    btn.textContent = 'Remove';
    btn.style.background = 'rgba(230, 57, 70, 0.9)';
  }

  document.getElementById('card-front').textContent = word.english;
  document.getElementById('card-back').textContent = word.chinese;
  document.getElementById('current-list-title').textContent = currentVocabList;
  document.getElementById('learn-progress').textContent = `${currentIndex + 1} / ${currentVocabs.length}`;
  document.querySelector('#flashcard').classList.remove('flipped');
  showScreen('flashcard-view');
}

function flipCard() { document.querySelector('#flashcard').classList.toggle('flipped'); }
function nextCard() { if (currentIndex < currentVocabs.length - 1) showFlashcard(currentIndex + 1); }
function prevCard() { if (currentIndex > 0) showFlashcard(currentIndex - 1); }
function exitFlashcards() { showScreen('learn-mode'); }

// --- UPDATED CARD ACTION LOGIC ---
async function handleCardAction() {
  const vocabId = currentVocabs[currentIndex].objectId;
  const isMovingBack = (currentVocabList === 'Removed Words');
  
  // Update local view first
  currentVocabs.splice(currentIndex, 1);

  // Sync with DB
  const progressRes = await leanRequest('GET', `/classes/StudentProgress?where=${encodeURIComponent(JSON.stringify({studentUsername: currentUser}))}`);
  let progressObj = progressRes.results[0];
  let removed = progressObj?.removedWords || [];

  if (isMovingBack) {
    // Remove from the removed list
    removed = removed.filter(id => id !== vocabId);
  } else {
    // Add to the removed list
    if (!removed.includes(vocabId)) removed.push(vocabId);
  }

  if (progressObj) {
    await leanRequest('PUT', `/classes/StudentProgress/${progressObj.objectId}`, { removedWords: removed });
  } else {
    await leanRequest('POST', '/classes/StudentProgress', { studentUsername: currentUser, removedWords: removed, errorWords: [] });
  }

  // Refresh view
  if (currentVocabs.length > 0) {
    if (currentIndex >= currentVocabs.length) currentIndex = currentVocabs.length - 1;
    showFlashcard(currentIndex);
  } else {
    alert(isMovingBack ? 'All words moved back!' : 'List finished!');
    exitFlashcards();
    await loadVocabLists();
    renderVocabLists('learn');
  }
}

function showQuizQuestion() {
  if (quizIndex >= quizQuestions.length) { showQuizResults(); return; }
  const current = quizQuestions[quizIndex];
  document.getElementById('quiz-list-title').textContent = currentVocabList;
  document.getElementById('quiz-progress').textContent = `${quizIndex + 1} / ${quizQuestions.length}`;
  document.getElementById('quiz-word').textContent = current.english;
  
  const others = quizQuestions.filter(q => q.objectId !== current.objectId).sort(() => 0.5 - Math.random()).slice(0, 2);
  const options = [current.chinese, ...others.map(o => o.chinese)].sort(() => 0.5 - Math.random());
  const optionsDiv = document.getElementById('quiz-options');
  optionsDiv.innerHTML = '';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      document.querySelectorAll('#quiz-options button').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedOptionBtn = { chosen: opt, correct: current.chinese };
    };
    optionsDiv.appendChild(btn);
  });
  showScreen('quiz-question');
}

async function submitQuizAnswer() {
  if (!selectedOptionBtn) return alert('Select an answer');
  const { chosen, correct } = selectedOptionBtn;
  const progressRes = await leanRequest('GET', `/classes/StudentProgress?where=${encodeURIComponent(JSON.stringify({studentUsername: currentUser}))}`);
  let progressObj = progressRes.results[0];

  if (chosen === correct) {
    correctCount++;
    if (currentVocabList === 'Error List' && progressObj) {
      let errors = (progressObj.errorWords || []).filter(id => id !== quizQuestions[quizIndex].objectId);
      await leanRequest('PUT', `/classes/StudentProgress/${progressObj.objectId}`, { errorWords: errors });
    }
  } else {
    wrongAnswers.push(quizQuestions[quizIndex]);
    let errors = progressObj?.errorWords || [];
    if (!errors.includes(quizQuestions[quizIndex].objectId)) {
      errors.push(quizQuestions[quizIndex].objectId);
      if (progressObj) await leanRequest('PUT', `/classes/StudentProgress/${progressObj.objectId}`, { errorWords: errors });
      else await leanRequest('POST', '/classes/StudentProgress', { studentUsername: currentUser, removedWords: [], errorWords: errors });
    }
  }
  quizIndex++; selectedOptionBtn = null; showQuizQuestion();
}

function showQuizResults() {
  const rate = ((correctCount / quizQuestions.length) * 100).toFixed(1);
  let html = `<h2>Quiz Complete! üéâ</h2><p style="text-align:center;">Score: ${rate}%</p>`;
  if (wrongAnswers.length > 0) {
    html += '<h3 style="margin-top:20px;">Review Missed Words:</h3><ul style="list-style:none; padding:10px;">';
    wrongAnswers.forEach(w => html += `<li style="margin-bottom:8px; color:var(--danger);">‚ùå ${w.english} ‚Üí ${w.chinese}</li>`);
    html += '</ul>';
  }
  html += '<button onclick="backToMenu()" style="margin-top:20px;">Finish</button>';
  document.getElementById('quiz-question').innerHTML = html;
}
</script>
</body>
</html>
